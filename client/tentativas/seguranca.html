<!DOCTYPE html>
<html lang="pt">
<head>
    <link rel="stylesheet" href="./css/style.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas</title>
</head>
<body>
    <div class="content">
        <div class="statusbar enemy">
            <div class="energybar enemy-energy">
                <div class="energy enemys"></div>
            </div>
            <div class="health your-health">
                <div class="healthpoint green"></div>
                <div class="healthpoint green"></div>
                <div class="healthpoint green"></div>
                <div class="healthpoint green"></div>
                <div class="healthpoint red"></div>
            </div>
        </div>
        <div class="game">
            <canvas width="30" height="30" id="screen">
                
            </canvas>
        </div>
        <div class="statusbar your">
            <div class="energybar your-energy">
                <div class="energy yours"></div>
            </div>
            <div class="health your-health">
                <div class="healthpoint green"></div>
                <div class="healthpoint green"></div>
                <div class="healthpoint green"></div>
                <div class="healthpoint red"></div>
                <div class="healthpoint red"></div>
            </div>
        </div>
    </div>
</body>
    <script>
        const screen = document.getElementById('screen')
        const context = screen.getContext('2d')

        function createGame() {
            const state = {
                players: {}
            }
            
            function addPlayer(command) {
                const { playerId, playerX, playerY, color, stamina, bullets } = command

                state.players[playerId] = {
                    x: playerX,
                    y: playerY,
                    color,
                    stamina: 3,
                    bullets: {},
                    hp: 5,
                }
            }

            function removePlayer(command) {
                const { playerId }= command

                delete state.players[playerId]
            }

            function addStamina(command) {
                const { player } = command

                setTimeout(()=>{ player.stamina++}, 3000)
            }

            function addBullet(command) {
                const { player, bulletId, bulletX, bulletY, color } = command

                player.bullets[bulletId] = {
                    x: bulletX,
                    y: bulletY,
                    color
                }

                player.stamina--
                addStamina({ player })

                console.log(player)
            }

            function removeBullet(command) {
                const { player, bulletId } = command

                delete player.bullets[bulletId]
            }

            function moveBullet(command) {
                const { player, bulletId } = command
                const bullet = player.bullets[bulletId]

                var interval = 0

                interval = setInterval(() => {
                    bullet.y = bullet.y - 1
                    if(bullet.y < 0) {
                        removeBullet({ player, bulletId })
                        clearInterval(interval)
                    }
                }, 35)
            }

            function movePlayer(command) {

                const acceptedMoves = {
                    ArrowUp(player) {
                        if(player.y > 15) {
                            player.y = player.y - 1
                        }
                    },
                    ArrowDown(player) {
                        if(player.y + 3 < screen.height) {
                            player.y = player.y + 1
                        }
                    },
                    ArrowLeft(player) {
                        if(player.x > 0) {
                            player.x = player.x - 1
                        }
                    },
                    ArrowRight(player) {
                        if(player.x + 3 < screen.height) {
                            player.x = player.x + 1
                        }
                    },
                    ' '(player) {
                        if(player.stamina > 0) {
                            const bulletId = Math.floor(Math.random() * 10000000)
                            game.addBullet({
                                bulletX: player.x + 1,
                                bulletY: player.y,
                                color: '#138CFC',
                                bulletId,
                                player
                            })
                            moveBullet({ player, bulletId })
                        }
                        
                    }
                }

                const { keyPressed, playerId } = command
                const player = state.players[playerId]
                const moveFunction = acceptedMoves[keyPressed]
                moveFunction && player ? moveFunction(player) : false
            }

            return {
                movePlayer,
                addPlayer,
                removePlayer,
                addBullet,
                state,
            }
        }

        const game = createGame()
        game.addPlayer({playerId: 'you', playerX: 13, playerY: 27, color: '#5EA7EA'})
        game.addPlayer({playerId: 'enemy', playerX: 13, playerY: 0 , color: '#EA5E5E'})
        const keyboardListener = createKeyboardListener()
        keyboardListener.subscribe(game.movePlayer)

        function createKeyboardListener() {
            const state = {
                observers: []
            }

            function subscribe(observerFunction){
                state.observers.push(observerFunction)
            }

            function notifyAll(command) {
                console.log(`Notifying ${state.observers.length} observers`)

                for(const observerFunction in state.observers) {
                    state.observers[observerFunction](command)
                }
            }

            document.addEventListener('keydown', handleKeydown)

            function handleKeydown(event) {
                const keyPressed = event.key
                
                const command = {
                    playerId: 'you',
                    keyPressed
                }

                notifyAll(command)
            }

            return {
                subscribe
            }
        }

        renderScreen()

        function renderScreen() {
            context.clearRect(0, 0, screen.width, screen.height)
            context.fillRect(0, screen.height / 2, screen.width, .1)

            for(const playerId in game.state.players) {
                const player = game.state.players[playerId]
                context.fillStyle = player.color
                context.fillRect(player.x, player.y, 3, 3)

                for(const bulletId in player.bullets) {
                    const bullet = player.bullets[bulletId]
                    context.fillStyle = bullet.color
                    context.fillRect(bullet.x, bullet.y, 1, 1)
                }

            }

            requestAnimationFrame(renderScreen)
        }

    </script>
</html>